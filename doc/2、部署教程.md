### 部署教程

本教程基于 `1Panel` 面板进行说明，其他方式可自行部署。

#### 1、安装 1Panel 面板

可参考 1Panel 官方文档：https://www.1panel.cn

#### 2、进入面板 > `应用商店` 安装软件

- **Java**
- **OpenResty**
- **Mysql**
- **Redis**
- **RabbitMq**

#### 3、进入 `网站` > `网站` `创建网站` 输入主域名 确认即可

#### 4、进入 `网站` > `网站` > 点击 `域名` > `网站目录` > `主目录` 点击右侧文件图标 进入文件管理

将 `manage` `jar` `index` 上传到此目录下

目录结构如下：

```agsl
    ├── index
    ├── jar
    ├── manage
    ├── ssl
```

#### 5、进入 `网站` > `网站` > 点击 `域名` > `伪静态` 粘贴内容，保存并重载

将内容中的 `e.daguoli.cn` 替换为你的域名

注意：需在服务器控制台 `安全组` 中开放 `8051` 或 `自定义端口` 否则无法访问后端数据

```agsl
location ^~/ {
    root /www/sites/e.daguoli.cn/index;
    try_files $uri $uri/ /index.html;
}
location ^~/manage {
    alias /www/sites/e.daguoli.cn/manage/;
    try_files $uri $uri/ /manage/index.html;
}
location ^~ /api/ {
    proxy_pass http://127.0.0.1:8051/;
    proxy_set_header Host $host:$server_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header REMOTE-HOST $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

#### 6、 jar/application.yml 文件配置

只列出需自行配置的参数

```agsl
ruoyi:
  profile: /home/fox/energy/files //文件上传路径，可自行修改

server:
  port: 8051 //服务器的HTTP端口，可自习修改为其他端口，与反向代理端口一致即可
spring:
  datasource:
    druid:
      master:
        //自行修改为 本机 mysql 连接信息
        url: jdbc:mysql://127.0.0.1:3306/energy-agent?useUnicode=true&characterEncoding=utf8&zeroDateTimeBehavior=convertToNull&useSSL=true&serverTimezone=GMT%2B8
        username: 
        password: 

  //自行修改为 本机 redis 连接信息
  redis:
    host: 127.0.0.1
    port: 16379
    database: 0
    password: //替换为redis连接密码
  //自行修改为 本机 rabbitmq 连接信息
  rabbitmq:
    host: 127.0.0.1
    port: 5672
    virtual-host: /
    username: rabbitmq
    password: rabbitmq

token:
  secret: //替换密码 //随机生成32为字符串替换即可
```

#### 7、项目启动

##### 启动后端

使用 `Supervisor` 创建守护进程进行启动及监控

进入 `面板` > `工具箱` > `进程守护`

若未安装 `Supervisor` 可参考 1Panel 官方文档：https://1panel.cn/docs/user_manual/toolbox/supervisor/

创建 `supervisor` 进程

- 名称：自定义
- 运行目录：/opt/1panel/apps/openresty/openresty/www/sites/e.daguoli.cn/jar
- 启动命令：nohup java -jar -Dloader.path=/opt/1panel/apps/openresty/openresty/www/sites/e.daguoli.cn/jar/lib energy.jar
  --spring.config.location=/opt/1panel/apps/openresty/openresty/www/sites/e.daguoli.cn/jar/application.yml &

以上均需自行修改 `e.daguoli.cn` 为 `你的域名`

确认，等待启动成功即可

##### 启动PC、管理端

上传文件到对应 `index` `manage` 目录，即可启动

#### 8、设置定时日志切割

进入 `面板` > `计划任务` > `创建任务`

- 任务类型：Shell脚本
- 任务名称：自定义
- 执行周期：每天 23小时59分钟
- 脚本内容：/opt/1panel/apps/openresty/openresty/www/sites/e.daguoli.cn/jar/splitLog.sh

需自行修改 `e.daguoli.cn` 为 `你的域名`

## **可提供软件部署服务，具体请联系 Email:admin@foxupay.com**